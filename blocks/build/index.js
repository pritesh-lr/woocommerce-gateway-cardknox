(()=>{"use strict";const e=window.wp.i18n,t=window.wp.htmlEntities,r=window.wp.element,n=window.React,o=({errors:t,onExpiryChange:o,ValidationInputError:a,cardData:c})=>{(new Date).getFullYear();const i=()=>{if(!c.expiryMonth||!c.expiryYear)return!1;const e=new Date,t=e.getFullYear(),r=e.getMonth()+1,n=parseInt(c.expiryMonth,10),o=parseInt(c.expiryYear,10);return!(o<t||o===t&&n<r)};return(0,r.useEffect)(()=>{const e=document.querySelector(".cardknox-iframe-container"),t=document.querySelector(".cvv-container");e&&(e.style.border="0"),t&&(t.style.border="0")},[]),(0,n.createElement)("div",{className:"wc-cardknox-ifields"},(0,n.createElement)("div",{id:"ifieldsError",style:{display:"none",color:"red",marginBottom:"10px"}}),(0,n.createElement)("div",{className:"form-row form-row-wide",style:{paddingBottom:"0",margin:"0 0 15px 0",width:"100%"}},(0,n.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-card-number"},(0,e.__)("Card Number","woocommerce-gateway-cardknox")," ",(0,n.createElement)("span",{className:"required"},"*")),(0,n.createElement)("div",{className:"cardknox-card-number-wrapper",style:{position:"relative"}},(0,n.createElement)("div",{className:"cardknox-iframe-container",style:{position:"relative",overflow:"hidden",backgroundColor:"#fff",height:"65px"}},(0,n.createElement)("iframe",{"data-ifields-id":"card-number","data-ifields-placeholder":(0,e.__)("Card Number","woocommerce-gateway-cardknox"),src:"https://cdn.cardknox.com/ifields/3.0.2503.2101/ifield.htm",frameBorder:"0",width:"100%",height:"100%",style:{border:0},title:"Card Number"})),(0,n.createElement)("div",{className:"card-logos",style:{position:"absolute",right:"50px",top:"40%",transform:"translateY(-50%)",height:"40px",width:"100%",backgroundImage:"url(https://plugin.cardknox.net/demo/wpdemo/wp-content/plugins/woocommerce-gateway-cardknox/images/card-logos.png)",backgroundSize:"auto",backgroundRepeat:"no-repeat",backgroundPosition:"center right",pointerEvents:"none"}})),(0,n.createElement)("div",{className:"cardknox-error-container"},(0,n.createElement)("div",{"data-ifields-id":"card-number-error"}),t.cardNumber&&(0,n.createElement)(a,{errorMessage:t.cardNumber}))),(0,n.createElement)("div",{className:"cardknox-row",style:{display:"flex",gap:"15px",marginBottom:"15px"}},(0,n.createElement)("div",{className:"form-row form-row-first",style:{flex:"1",margin:"0"}},(0,n.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-expiry"},(0,e.__)("Expiry (MM/YY)","woocommerce-gateway-cardknox")," ",(0,n.createElement)("span",{className:"required"},"*")),(0,n.createElement)("input",{id:"cardknox-card-expiry",className:"input-text wc-credit-card-form-card-expiry",inputMode:"numeric",autoComplete:"cc-exp",autoCorrect:"no",autoCapitalize:"no",spellCheck:"no",type:"tel",placeholder:(0,e.__)("MM / YY","woocommerce-gateway-cardknox"),style:{outline:"none",border:t.expiry||!i()&&c.expiryMonth&&c.expiryYear?"1px solid red":"1px solid #000",borderRadius:"4px",padding:"0.618047em",width:"100%",height:"48px",backgroundColor:"#fff",fontWeight:"inherit",boxSizing:"border-box",fontSize:"16px"},onChange:e=>{const t=e.target.value.replace(/\D/g,"");let r=t;if(t.length>=2&&(r=t.substr(0,2)+" / "+t.substr(2,2)),e.target.value=r,t.length>=2){const e=t.substr(0,2);o("expiryMonth",e)}if(4===t.length){const e="20"+t.substr(2,2);o("expiryYear",e)}}}),(t.expiry||!i()&&c.expiryMonth&&c.expiryYear)&&(0,n.createElement)(a,{errorMessage:t.expiry||(0,e.__)("Expiration must be in the future","woocommerce-gateway-cardknox")})),(0,n.createElement)("div",{className:"form-row form-row-last",style:{flex:"1",margin:"0"}},(0,n.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-cvv"},(0,e.__)("Card Code","woocommerce-gateway-cardknox")," ",(0,n.createElement)("span",{className:"required"},"*")),(0,n.createElement)("div",{className:"cardknox-iframe-container cvv-container",style:{position:"relative",overflow:"hidden",backgroundColor:"#fff",height:"65px"}},(0,n.createElement)("iframe",{"data-ifields-id":"cvv","data-ifields-placeholder":(0,e.__)("CVV","woocommerce-gateway-cardknox"),src:"https://cdn.cardknox.com/ifields/3.0.2503.2101/ifield.htm",frameBorder:"0",width:"100%",height:"100%",style:{border:0},title:"CVV"})),(0,n.createElement)("div",{"data-ifields-id":"cvv-error"}),t.cvv&&(0,n.createElement)(a,{errorMessage:t.cvv}))),(0,n.createElement)("input",{type:"hidden","data-ifields-id":"card-number-token",name:"xCardNum"}),(0,n.createElement)("input",{type:"hidden","data-ifields-id":"cvv-token",name:"xCVV"}),(0,n.createElement)("div",{className:"clear"}))},a=({checked:t,onChange:r})=>(0,n.createElement)("div",{className:"wc-payment-gateway-cardknox__save-payment-method wc-block-components-payment-methods__save-card-info"},(0,n.createElement)("label",{className:"wc-block-components-checkbox wc-block-components-payment-methods__save-card-infos-checkbox"},(0,n.createElement)("input",{type:"checkbox",name:"wc-cardknox-new-payment-method",id:"wc-cardknox-new-payment-method",className:"wc-block-components-checkbox__input",checked:t,onChange:e=>r(e.target.checked)}),(0,n.createElement)("svg",{className:"wc-block-components-checkbox__mark","aria-hidden":"true",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 20"},(0,n.createElement)("path",{d:"M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"})),(0,n.createElement)("span",{className:"wc-block-components-chesckbox__label"},(0,e.__)("Save payment information to my account for future purchases.","woocommerce-gateway-cardknox")))),c=t=>{const c=t.eventRegistration||t.events,i=t.emitResponse,d=t.components||{},s=window.wc&&window.wc.wcSettings?window.wc.wcSettings.getSetting("cardknox_data",{}):window.wcSettings?window.wcSettings.getSetting("cardknox_data",{}):{},[l,u]=(0,r.useState)({}),[m,w]=(0,r.useState)(!1),[f,p]=(0,r.useState)(!1),[y,v]=(0,r.useState)("new"),[x,b]=(0,r.useState)({cardNumber:"",cvv:"",expiryMonth:"",expiryYear:"",cardNumberToken:"",cvvToken:""}),g=(0,r.useRef)(0),h=(0,r.useRef)(null),k=(0,r.useRef)(x),E=(0,r.useRef)(i),I=(0,r.useRef)(null),S=(0,r.useRef)(x),C=(0,r.useRef)(f),_=(0,r.useRef)(y),N=(0,r.useRef)(l),V=(0,r.useRef)(c),q=(0,r.useRef)({subscribed:!1,unsubscribe:null});(0,r.useEffect)(()=>{g.current+=1});const{initializeIFields:M,getTokens:R,clearFields:F,focusField:T}=(()=>{const e=(0,r.useRef)(!1),t=(0,r.useRef)(null),n=()=>{document.querySelectorAll(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").forEach(e=>e.remove())};return{initializeIFields:(0,r.useCallback)(({iFieldsKey:r,softwareName:o,softwareVersion:a,onUpdate:c})=>{if(e.current)return;if(!window.setAccount)return;t.current=c||null,window.setAccount(r,o,a);const i={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"93%",height:"30px","background-color":"transparent","font-weight":"inherit","box-shadow":"none","font-size":"16px","font-family":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},d={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"86%",height:"28px","background-color":"transparent","font-weight":"inherit","box-shadow":"none","font-size":"16px","font-family":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},s={...i,border:"1px solid #46b450","background-color":"#f0f9f0"},l={...i,border:"1px solid #d63638","background-color":"#fef5f5"},u={...d,border:"1px solid #46b450","background-color":"#f0f9f0"},m={...d,border:"1px solid #d63638","background-color":"#fef5f5"};window.setIfieldStyle&&(window.setIfieldStyle("card-number",i),window.setIfieldStyle("cvv",d)),window.enableAutoFormatting&&window.enableAutoFormatting(),window.enableEnterKey&&(window.enableEnterKey("card-number"),window.enableEnterKey("cvv")),window.addIfieldCallback&&window.setIfieldStyle?(window.addIfieldCallback("input",function(e){t.current?.(e);const r=document.querySelector('[data-ifields-id="card-number-error"]'),o=document.querySelector('[data-ifields-id="cvv-error"]'),a="number"==typeof e.cardNumberLength?e.cardNumberLength:0,c="number"==typeof e.cvvLength?e.cvvLength:0;window.setIfieldStyle("card-number",a<=0?i:e.cardNumberIsValid?s:l),r&&(r.textContent=a<=0?"Card Number is required":e.cardNumberIsValid?"":"Invalid card number",r.setAttribute("aria-hidden",r.textContent?"false":"true"));const w=c===("amex"===e.issuer?4:3)&&e.cvvIsValid;window.setIfieldStyle("cvv","unknown"===e.issuer||c<=0?d:w?u:m),o&&(o.textContent=c<=0?"CVV is required":w?"":"Invalid CVV",o.setAttribute("aria-hidden",o.textContent?"false":"true")),e.cardNumberIsValid&&w&&n()}),window.addIfieldCallback("issuerupdated",function(e){const t="number"==typeof e.cvvLength?e.cvvLength:0,r=t===("amex"===e.issuer?4:3)&&e.cvvIsValid;window.setIfieldStyle("cvv","unknown"===e.issuer||t<=0?d:r?u:m)})):window.addIfieldKeyPressCallback&&window.setIfieldStyle&&window.addIfieldKeyPressCallback(function(e){t.current?.(e);const r=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value,a=document.querySelector('[data-ifields-id="card-number-error"]'),c=document.querySelector('[data-ifields-id="cvv-error"]');r||e.cardNumberIsValid?(window.setIfieldStyle("card-number",s),a&&(a.textContent="")):e.cardNumberLength>0?(window.setIfieldStyle("card-number",l),a&&(a.textContent="Invalid card number")):(window.setIfieldStyle("card-number",i),a&&(a.textContent="Card Number is required")),o||e.cvvIsValid?(window.setIfieldStyle("cvv",u),c&&(c.textContent="")):e.cvvLength>0?(window.setIfieldStyle("cvv",m),c&&(c.textContent="Invalid CVV")):(window.setIfieldStyle("cvv",d),c&&(c.textContent="CVV is required")),(r||e.cardNumberIsValid)&&(o||e.cvvIsValid)&&n()}),e.current=!0},[]),getTokens:(0,r.useCallback)(()=>new Promise((e,t)=>{if(!window.getTokens)return void t(new Error("iFields not initialized"));const r=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value;if(r&&o)return n(),void e({cardNumberToken:r,cvvToken:o});const a=document.querySelector('[data-ifields-id="card-number-error"]'),c=document.querySelector('[data-ifields-id="cvv-error"]');a&&(a.textContent=""),c&&(c.textContent="");let i=!1;const d=setTimeout(()=>{i||(i=!0,t(new Error("Timed out while validating card fields")))},15e3);window.getTokens(()=>{if(i)return;i=!0,clearTimeout(d);const r=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value;if(!r||!o)return r||(a&&(a.textContent="Card Number is required"),window.setIfieldStyle&&window.setIfieldStyle("card-number",{border:"1px solid #d63638"}),window.focusIfield&&window.focusIfield("card-number")),o||(c&&(c.textContent="CVV is required"),window.setIfieldStyle&&window.setIfieldStyle("cvv",{border:"1px solid #d63638"}),r&&window.focusIfield&&window.focusIfield("cvv")),void t(new Error("Please fill in all required fields"));window.setIfieldStyle&&window.setIfieldStyle("card-number",{border:"1px solid #46b450"}),window.setIfieldStyle&&window.setIfieldStyle("cvv",{border:"1px solid #46b450"}),a&&(a.textContent="",a.setAttribute("aria-hidden","true")),c&&(c.textContent="",c.setAttribute("aria-hidden","true")),n(),e({cardNumberToken:r,cvvToken:o})},e=>{if(i)return;i=!0,clearTimeout(d);const r=document.querySelector('[data-ifields-id="card-number-error"]'),n=document.querySelector('[data-ifields-id="cvv-error"]');if(r&&!r.textContent&&(r.textContent="Invalid card number"),n&&!n.textContent&&(n.textContent="Invalid CVV"),window.focusIfield){const e=window.getLastIfieldState&&window.getLastIfieldState(),t=e&&e.cardNumberIsValid?"cvv":"card-number";window.focusIfield(t)}t(new Error("string"==typeof e?e:"Failed to get tokens"))},15e3)}),[]),clearFields:(0,r.useCallback)(()=>{window.clearIfield&&(window.clearIfield("card-number"),window.clearIfield("cvv"))},[]),focusField:(0,r.useCallback)(e=>{window.focusIfield&&window.focusIfield(e)},[])}})();(0,r.useEffect)(()=>{E.current=i},[i]),(0,r.useEffect)(()=>{I.current=R},[R]),(0,r.useEffect)(()=>{S.current=x},[x]),(0,r.useEffect)(()=>{C.current=f},[f]),(0,r.useEffect)(()=>{_.current=y},[y]),(0,r.useEffect)(()=>{N.current=l},[l]),(0,r.useEffect)(()=>{V.current=c},[c]),(0,r.useEffect)(()=>{h.current,h.current=R},[R]),(0,r.useEffect)(()=>{k.current,k.current=x},[x]);const Y=d.ValidationInputError||(({errorMessage:e})=>e?(0,n.createElement)("div",{className:"wc-block-components-validation-error",role:"alert"},(0,n.createElement)("span",null,e)):null);(0,r.useEffect)(()=>{const e=()=>{const e=!!s.iFieldsKey,t=!!window.setAccount&&!!window.setIfieldStyle&&!!window.addIfieldCallback;e&&t&&M({iFieldsKey:s.iFieldsKey,softwareName:s.softwareName||"WooCommerce",softwareVersion:s.softwareVersion||"1.0.0",onUpdate:L})};e();const t=window.setTimeout(e,300);return()=>{window.clearTimeout(t)}},[s.iFieldsKey]),(0,r.useEffect)(()=>{let t=!1,r=null;const n=()=>{if(t||q.current.subscribed)return;const o=V.current,a=o?.onPaymentSetup,c=o?.onPaymentProcessing,i=a||c;if(!i||!E.current)return void(r=window.setTimeout(n,200));const d=i(async()=>{const t=E.current,r=_.current,n=S.current;try{if("new"!==r)return{type:t.responseTypes.SUCCESS,meta:{paymentMethodData:{wc_token:r}}};const o=(t=>{const r={};if(t.expiryMonth){const n=parseInt(t.expiryMonth,10);(n<1||n>12)&&(r.expiry=(0,e.__)("Invalid expiry month","woocommerce-gateway-cardknox"))}else r.expiry=(0,e.__)("Expiry month is required","woocommerce-gateway-cardknox");if(t.expiryYear){const n=(new Date).getFullYear(),o=parseInt(t.expiryYear,10);if(o<n&&(r.expiry=(0,e.__)("Card has expired","woocommerce-gateway-cardknox")),o===n&&t.expiryMonth){const n=(new Date).getMonth()+1;parseInt(t.expiryMonth,10)<n&&(r.expiry=(0,e.__)("Card has expired","woocommerce-gateway-cardknox"))}}else r.expiry=(0,e.__)("Expiry year is required","woocommerce-gateway-cardknox");return r})(n)||{};if(n.expiryMonth&&n.expiryYear){const t=new Date,r=t.getFullYear(),a=t.getMonth()+1,c=parseInt(n.expiryMonth,10),i=parseInt(n.expiryYear,10);(i<r||i===r&&c<a)&&(o.expiry=(0,e.__)("Expiration must be in the future","woocommerce-gateway-cardknox"))}else o.expiry=(0,e.__)("Expiry date is required","woocommerce-gateway-cardknox");if(Object.keys(o).length>0)return u(o),{type:t.responseTypes.ERROR,message:(0,e.__)("Please check your card details.","woocommerce-gateway-cardknox")};u({});const a=await I.current();return a?.cardNumberToken&&a?.cvvToken?{type:t.responseTypes.SUCCESS,meta:{paymentMethodData:{cardknox_card_token:a.cardNumberToken,cardknox_cvv_token:a.cvvToken,cardknox_exp_month:n.expiryMonth,cardknox_exp_year:n.expiryYear,cardknox_save_card:C.current?"yes":"no","wc-cardknox-new-payment-method":C.current?"1":""}}}:{type:t.responseTypes.ERROR,message:(0,e.__)("Unable to process card data. Please try again.","woocommerce-gateway-cardknox")}}catch(r){return{type:t.responseTypes.ERROR,message:r?.message||(0,e.__)("Payment processing failed.","woocommerce-gateway-cardknox")}}});q.current={subscribed:!0,unsubscribe:d}};return n(),()=>{t=!0,r&&window.clearTimeout(r);const{unsubscribe:e}=q.current||{};"function"==typeof e&&e()}},[]);const L=(0,r.useCallback)(t=>{const r={...l},n=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value;"card-number"!==t.lastActiveField&&void 0===t.cardNumberLength||(n||t.cardNumberIsValid?delete r.cardNumber:t.cardNumberLength>0&&!t.cardNumberIsValid?r.cardNumber=(0,e.__)("Invalid card number","woocommerce-gateway-cardknox"):delete r.cardNumber),"cvv"!==t.lastActiveField&&void 0===t.cvvLength||(o||t.cvvIsValid?delete r.cvv:t.cvvLength>0&&!t.cvvIsValid?r.cvv=(0,e.__)("Invalid CVV","woocommerce-gateway-cardknox"):delete r.cvv),u(r);const a=!(!n&&!t.cardNumberIsValid),c=!(!o&&!t.cvvIsValid);w(a&&c);const i=document.querySelector(".cardknox-iframe-container"),d=document.querySelector(".cvv-container");i&&(i.style.border="0"),d&&(d.style.border="0")},[l]);return(0,n.createElement)("div",{className:"wc-cardknox-payment-form"},"new"===y&&(0,n.createElement)(n.Fragment,null,(0,n.createElement)(o,{errors:l,onExpiryChange:(e,t)=>{b(r=>({...r,[e]:t}));const r={...l};delete r.expiry,u(r)},ValidationInputError:Y,cardData:x}),s.showSaveOption&&(0,n.createElement)(a,{checked:f,onChange:p})))};var i,d;const s=window.wc&&window.wc.wcSettings?window.wc.wcSettings.getSetting("cardknox_data",{}):window.wcSettings?window.wcSettings.getSetting("cardknox_data",{}):{},l=(0,e.__)("Credit Card (Cardknox)","woocommerce-gateway-cardknox"),u=(0,t.decodeEntities)(s.title)||l,m=e=>(0,r.createElement)(c,e),w={name:"cardknox",label:(0,r.createElement)(()=>(0,r.createElement)("span",null,u)),content:(0,r.createElement)(m),edit:(0,r.createElement)(m),canMakePayment:()=>!0,ariaLabel:u,supports:{features:null!==(i=s.supports)&&void 0!==i?i:["products"],showSaveOption:null!==(d=s.showSaveOption)&&void 0!==d&&d,showSavedCards:Array.isArray(s.savedCards)&&s.savedCards.length>0},placeOrderButtonLabel:(0,e.__)("Place Order","woocommerce-gateway-cardknox")},{registerPaymentMethod:f}=window.wc.wcBlocksRegistry;f&&f(w)})();