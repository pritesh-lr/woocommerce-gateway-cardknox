(()=>{"use strict";const e=window.wp.i18n,t=window.wp.htmlEntities,r=window.wp.element,o=window.React,n=({errors:t,onExpiryChange:n,ValidationInputError:a,cardData:c})=>{const i=(0,r.useRef)(null),d=(0,r.useRef)(null);(0,r.useEffect)(()=>{if(i.current&&!i.current.querySelector("iframe")){const e=document.createElement("iframe");e.setAttribute("data-ifields-id","card-number"),e.setAttribute("data-ifields-placeholder","Card Number"),e.src="https://cdn.cardknox.com/ifields/3.0.2503.2101/ifield.htm",e.style.width="100%",e.style.height="100%",e.style.border="none",e.style.backgroundColor="transparent",e.frameBorder="0",i.current.appendChild(e);const t=document.createElement("div");t.setAttribute("data-ifields-id","card-number-error"),t.style.color="red",t.style.marginTop="5px",t.style.marginBottom="5px",t.style.display="block",t.style.clear="both",t.style.width="100%",t.style.fontSize="14px",i.current.appendChild(t)}if(d.current&&!d.current.querySelector("iframe")){const e=document.createElement("iframe");e.setAttribute("data-ifields-id","cvv"),e.setAttribute("data-ifields-placeholder","CVV"),e.src="https://cdn.cardknox.com/ifields/3.0.2503.2101/ifield.htm",e.style.width="100%",e.style.height="100%",e.style.border="none",e.style.backgroundColor="transparent",e.frameBorder="0",d.current.appendChild(e);const t=document.createElement("div");t.setAttribute("data-ifields-id","cvv-error"),t.style.color="red",t.style.marginTop="5px",t.style.marginBottom="5px",t.style.display="block",t.style.clear="both",t.style.width="100%",t.style.fontSize="14px",d.current.appendChild(t)}if(window.setIfieldStyle){const e={outline:"none",border:"1px solid #c3c3c3",borderRadius:"4px",padding:"0.6180469716em",width:"95%",height:"35px",backgroundColor:"transparent",fontWeight:"inherit",boxShadow:"none",fontSize:"16px",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},t={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"88%",height:"30px","background-color":"transparent","font-weight":"inherit","box-shadow":"none","font-size":"16px","font-family":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'};window.setIfieldStyle("card-number",e),window.setIfieldStyle("cvv",t)}},[]),(0,r.useEffect)(()=>{if(window.setIfieldStyle){const e={border:"1px solid #c3c3c3"},r={border:"1px solid red"};t.cardNumber?window.setIfieldStyle("card-number",r):window.setIfieldStyle("card-number",e),t.cvv?window.setIfieldStyle("cvv",r):window.setIfieldStyle("cvv",e)}},[t]);const s=(new Date).getFullYear(),l=(Array.from({length:20},(e,t)=>s+t),()=>{if(!c.expiryMonth||!c.expiryYear)return!1;const e=new Date,t=e.getFullYear(),r=e.getMonth()+1,o=parseInt(c.expiryMonth,10),n=parseInt(c.expiryYear,10);return!(n<t||n===t&&o<r)});return(0,o.createElement)("div",{className:"wc-cardknox-ifields"},(0,o.createElement)("div",{id:"ifieldsError",style:{display:"none",color:"red",marginBottom:"10px"}}),(0,o.createElement)("div",{className:"form-row form-row-wide",style:{paddingBottom:"0",margin:"0 0 15px 0",width:"100%"}},(0,o.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-card-number"},(0,e.__)("Card Number","woocommerce-gateway-cardknox")," ",(0,o.createElement)("span",{className:"required"},"*")),(0,o.createElement)("div",{className:"cardknox-card-number-wrapper",style:{position:"relative"}},(0,o.createElement)("div",{ref:i,className:"cardknox-iframe-container",style:{backgroundColor:"#fff",height:"65px",border:"1px solid #c3c3c3",borderRadius:"4px"}}),(0,o.createElement)("div",{className:"card-logos",style:{position:"absolute",right:"50px",top:"43%",transform:"translateY(-50%)",height:"40px",width:"100%",backgroundImage:"url(https://plugin.cardknox.net/demo/wpdemo/wp-content/plugins/woocommerce-gateway-cardknox/images/card-logos.png)",backgroundSize:"auto",backgroundRepeat:"no-repeat",backgroundPosition:"center right",pointerEvents:"none"}})),(0,o.createElement)("div",{className:"cardknox-error-container"},t.cardNumber&&(0,o.createElement)(a,{errorMessage:t.cardNumber}))),(0,o.createElement)("div",{className:"cardknox-row",style:{display:"flex",gap:"15px",marginBottom:"15px"}},(0,o.createElement)("div",{className:"form-row form-row-first",style:{flex:"1",margin:"0"}},(0,o.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-expiry"},(0,e.__)("Expiry (MM/YY)","woocommerce-gateway-cardknox")," ",(0,o.createElement)("span",{className:"required"},"*")),(0,o.createElement)("input",{id:"cardknox-card-expiry",className:"input-text wc-credit-card-form-card-expiry",inputMode:"numeric",autoComplete:"cc-exp",autoCorrect:"no",autoCapitalize:"no",spellCheck:"no",type:"tel",placeholder:(0,e.__)("MM / YY","woocommerce-gateway-cardknox"),style:{outline:"none",border:t.expiry||!l()&&c.expiryMonth&&c.expiryYear?"1px solid red":"1px solid rgb(195, 195, 195)",borderRadius:"4px",padding:"0.618047em",width:"100%",height:"52px",backgroundColor:"#fff",fontWeight:"inherit",boxSizing:"border-box",fontSize:"16px"},onChange:e=>{const t=e.target.value.replace(/\D/g,"");let r=t;if(t.length>=2&&(r=t.substr(0,2)+" / "+t.substr(2,2)),e.target.value=r,t.length>=2){const e=t.substr(0,2);n("expiryMonth",e)}if(4===t.length){const e="20"+t.substr(2,2);n("expiryYear",e)}}}),(t.expiry||!l()&&c.expiryMonth&&c.expiryYear)&&(0,o.createElement)(a,{errorMessage:t.expiry||(0,e.__)("Expiration must be in the future","woocommerce-gateway-cardknox")})),(0,o.createElement)("div",{className:"form-row form-row-last",style:{flex:"1",margin:"0"}},(0,o.createElement)("label",{style:{margin:"0 0 5px 0",lineHeight:"inherit",display:"block",fontWeight:400},htmlFor:"cardknox-cvv"},(0,e.__)("Card Code","woocommerce-gateway-cardknox")," ",(0,o.createElement)("span",{className:"required"},"*")),(0,o.createElement)("div",{ref:d,className:"cardknox-iframe-container cvv-container",style:{backgroundColor:"#fff",height:"65px",border:"1px solid #c3c3c3",borderRadius:"4px"}}),t.cvv&&(0,o.createElement)(a,{errorMessage:t.cvv}))),(0,o.createElement)("div",{style:{marginBottom:"10px"}},(0,o.createElement)("label",{"data-ifields-id":"card-data-error",style:{color:"red"}})),(0,o.createElement)("input",{type:"hidden","data-ifields-id":"card-number-token",name:"xCardNum"}),(0,o.createElement)("input",{type:"hidden","data-ifields-id":"cvv-token",name:"xCVV"}),(0,o.createElement)("div",{className:"clear"}))},a=({checked:t,onChange:r})=>(0,o.createElement)("div",{className:"wc-payment-gateway-cardknox__save-payment-method wc-block-components-payment-methods__save-card-info"},(0,o.createElement)("label",{className:"wc-block-components-checkbox wc-block-components-payment-methods__save-card-infos-checkbox"},(0,o.createElement)("input",{type:"checkbox",name:"wc-cardknox-new-payment-method",id:"wc-cardknox-new-payment-method",className:"wc-block-components-checkbox__input",checked:t,onChange:e=>r(e.target.checked)}),(0,o.createElement)("svg",{className:"wc-block-components-checkbox__mark","aria-hidden":"true",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 20"},(0,o.createElement)("path",{d:"M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"})),(0,o.createElement)("span",{className:"wc-block-components-chesckbox__label"},(0,e.__)("Save payment information to my account for future purchases.","woocommerce-gateway-cardknox")))),c=t=>{const c=t.eventRegistration||t.events,i=t.emitResponse||t.emitResponse,d=t.components||{},s=window.wc&&window.wc.wcSettings?window.wc.wcSettings.getSetting("cardknox_data",{}):window.wcSettings?window.wcSettings.getSetting("cardknox_data",{}):{},[l,m]=(0,r.useState)({}),[u,p]=(0,r.useState)(!1),[w,y]=(0,r.useState)(!1),[x,f]=(0,r.useState)("new"),[g,b]=(0,r.useState)({cardNumber:"",cvv:"",expiryMonth:"",expiryYear:"",cardNumberToken:"",cvvToken:""}),{initializeIFields:h,getTokens:v,clearFields:k,focusField:S}=(()=>{const e=(0,r.useRef)(!1),t=(0,r.useRef)(null),o=(0,r.useRef)(null);return{initializeIFields:(0,r.useCallback)(({iFieldsKey:r,softwareName:n,softwareVersion:a,onUpdate:c,onSubmit:i})=>{if(e.current||!window.setAccount)return;t.current=c,o.current=i,window.setAccount(r,n,a);const d={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"93%",height:"40px","background-color":"transparent","font-weight":"inherit","box-shadow":"none","font-size":"16px","font-family":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},s={outline:"none",border:"1px solid #c3c3c3","border-radius":"4px",padding:"0.6180469716em",width:"95%",height:"30px","background-color":"transparent","font-weight":"inherit","box-shadow":"none","font-size":"16px","font-family":'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},l={...d,border:"1px solid green"},m={...d,border:"1px solid red"},u={...s,border:"1px solid green"},p={...s,border:"1px solid red"};window.setIfieldStyle("card-number",d),window.setIfieldStyle("cvv",s),window.enableAutoFormatting(),window.enableAutoSubmit(function(){o.current&&o.current()}),window.addIfieldKeyPressCallback(function(e){t.current&&t.current(e);const r=document.querySelector('[data-ifields-id="card-number-error"]'),o=document.querySelector('[data-ifields-id="cvv-error"]'),n=document.querySelector(".cardknox-iframe-container"),a=document.querySelector(".cvv-container"),c=document.querySelector('[data-ifields-id="card-number-token"]')?.value,i=document.querySelector('[data-ifields-id="cvv-token"]')?.value;c||e.cardNumberIsValid?(window.setIfieldStyle("card-number",l),r&&(r.textContent=""),n&&(n.style.border="1px solid green")):e.cardNumberLength>0&&!e.cardNumberIsValid?(window.setIfieldStyle("card-number",m),r&&(r.textContent="Invalid card number"),n&&(n.style.border="1px solid red")):(window.setIfieldStyle("card-number",d),r&&(r.textContent=""),n&&(n.style.border="1px solid #c3c3c3")),i||e.cvvIsValid?(window.setIfieldStyle("cvv",u),o&&(o.textContent=""),a&&(a.style.border="1px solid green")):e.cvvLength>0&&!e.cvvIsValid?(window.setIfieldStyle("cvv",p),o&&(o.textContent="Invalid CVV"),a&&(a.style.border="1px solid red")):(window.setIfieldStyle("cvv",s),o&&(o.textContent=""),a&&(a.style.border="1px solid #c3c3c3"))}),e.current=!0},[]),getTokens:(0,r.useCallback)(()=>new Promise((e,t)=>{if(!window.getTokens)return void t(new Error("iFields not initialized"));const r=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value;if(r&&o)return void e({cardNumberToken:r,cvvToken:o});const n=document.querySelector('[data-ifields-id="card-number-error"]'),a=document.querySelector('[data-ifields-id="cvv-error"]');n&&(n.textContent=""),a&&(a.textContent=""),window.getTokens(function(){const r=document.querySelector('[data-ifields-id="card-number-token"]')?.value,o=document.querySelector('[data-ifields-id="cvv-token"]')?.value;if(!r){n&&(n.textContent="Card Number is required");const e=document.querySelector(".cardknox-iframe-container");e&&(e.style.border="1px solid red"),window.setIfieldStyle("card-number",{border:"1px solid red"})}if(!o){a&&(a.textContent="CVV is required");const e=document.querySelector(".cvv-container");e&&(e.style.border="1px solid red"),window.setIfieldStyle("cvv",{border:"1px solid red"})}r&&o?e({cardNumberToken:r,cvvToken:o}):t(new Error("Please fill in all required fields"))},function(e){t(new Error(e||"Failed to get tokens"))},15e3)}),[]),clearFields:(0,r.useCallback)(()=>{window.clearIfield&&(window.clearIfield("card-number"),window.clearIfield("cvv"))},[]),focusField:(0,r.useCallback)(e=>{window.focusIfield&&window.focusIfield(e)},[])}})(),E=d.ValidationInputError||(({errorMessage:e})=>e?(0,o.createElement)("div",{className:"wc-block-components-validation-error",role:"alert"},(0,o.createElement)("span",null,e)):null);(0,r.useEffect)(()=>{window.setAccount&&s.iFieldsKey&&h({iFieldsKey:s.iFieldsKey,softwareName:s.softwareName||"WooCommerce",softwareVersion:s.softwareVersion||"1.0.0",onUpdate:_,onSubmit:C})},[s.iFieldsKey]),(0,r.useEffect)(()=>{if(!c||!i)return;const{onPaymentProcessing:t,onPaymentSetup:r}=c,o=t||r;if(!o)return;const n=o(async()=>{if("new"!==x)return{type:i.responseTypes.SUCCESS,meta:{paymentMethodData:{wc_token:x}}};const t=(t=>{const r={};if(t.expiryMonth){const o=parseInt(t.expiryMonth,10);(o<1||o>12)&&(r.expiry=(0,e.__)("Invalid expiry month","woocommerce-gateway-cardknox"))}else r.expiry=(0,e.__)("Expiry month is required","woocommerce-gateway-cardknox");if(t.expiryYear){const o=(new Date).getFullYear(),n=parseInt(t.expiryYear,10);if(n<o&&(r.expiry=(0,e.__)("Card has expired","woocommerce-gateway-cardknox")),n===o&&t.expiryMonth){const o=(new Date).getMonth()+1;parseInt(t.expiryMonth,10)<o&&(r.expiry=(0,e.__)("Card has expired","woocommerce-gateway-cardknox"))}}else r.expiry=(0,e.__)("Expiry year is required","woocommerce-gateway-cardknox");return r})(g);if(g.expiryMonth&&g.expiryYear){const r=new Date,o=r.getFullYear(),n=r.getMonth()+1,a=parseInt(g.expiryMonth,10),c=parseInt(g.expiryYear,10);(c<o||c===o&&a<n)&&(t.expiry=(0,e.__)("Expiration must be in the future","woocommerce-gateway-cardknox"))}else t.expiry=(0,e.__)("Expiry date is required","woocommerce-gateway-cardknox");if(Object.keys(t).length>0)return m(t),{type:i.responseTypes.ERROR,message:(0,e.__)("Please check your card details.","woocommerce-gateway-cardknox")};try{m({});const t=await v();return t.cardNumberToken&&t.cvvToken?{type:i.responseTypes.SUCCESS,meta:{paymentMethodData:{cardknox_card_token:t.cardNumberToken,cardknox_cvv_token:t.cvvToken,cardknox_exp_month:g.expiryMonth,cardknox_exp_year:g.expiryYear,cardknox_save_card:w?"yes":"no","wc-cardknox-new-payment-method":w?"1":""}}}:{type:i.responseTypes.ERROR,message:(0,e.__)("Unable to process card data. Please try again.","woocommerce-gateway-cardknox")}}catch(t){return{type:i.responseTypes.ERROR,message:t.message||(0,e.__)("Payment processing failed.","woocommerce-gateway-cardknox")}}});return()=>{"function"==typeof n&&n()}},[c,i,g,w,x,v]);const _=(0,r.useCallback)(t=>{if("input"===t.event){const r={...l},o=document.querySelector('[data-ifields-id="card-number-token"]')?.value,n=document.querySelector('[data-ifields-id="cvv-token"]')?.value;"card-number"===t.lastActiveField&&(o||t.cardNumberIsValid?delete r.cardNumber:t.cardNumberLength>0&&!t.cardNumberIsValid?r.cardNumber=(0,e.__)("Invalid card number","woocommerce-gateway-cardknox"):delete r.cardNumber),"cvv"===t.lastActiveField&&(n||t.cvvIsValid?delete r.cvv:t.cvvLength>0&&!t.cvvIsValid?r.cvv=(0,e.__)("Invalid CVV","woocommerce-gateway-cardknox"):delete r.cvv),m(r);const a=o||t.cardNumberIsValid,c=n||t.cvvIsValid;p(a&&c)}},[l]),C=(0,r.useCallback)(()=>{const e=document.querySelector(".wc-block-components-checkout-place-order-button");e&&e.click()},[]);return(0,o.createElement)("div",{className:"wc-cardknox-payment-form"},"new"===x&&(0,o.createElement)(o.Fragment,null,(0,o.createElement)(n,{errors:l,onExpiryChange:(e,t)=>{b(r=>({...r,[e]:t}));const r={...l};delete r.expiry,m(r)},ValidationInputError:E,cardData:g}),s.showSaveOption&&(0,o.createElement)(a,{checked:w,onChange:y})))};var i,d;const s=window.wc&&window.wc.wcSettings?window.wc.wcSettings.getSetting("cardknox_data",{}):window.wcSettings?window.wcSettings.getSetting("cardknox_data",{}):{},l=(0,e.__)("Credit Card (Cardknox)","woocommerce-gateway-cardknox"),m=(0,t.decodeEntities)(s.title)||l,u=e=>(0,r.createElement)(c,e),p={name:"cardknox",label:(0,r.createElement)(()=>(0,r.createElement)("span",null,m)),content:(0,r.createElement)(u),edit:(0,r.createElement)(u),canMakePayment:()=>!0,ariaLabel:m,supports:{features:null!==(i=s.supports)&&void 0!==i?i:["products"],showSaveOption:null!==(d=s.showSaveOption)&&void 0!==d&&d},placeOrderButtonLabel:(0,e.__)("Place Order","woocommerce-gateway-cardknox")},{registerPaymentMethod:w}=window.wc.wcBlocksRegistry;w&&w(p)})();